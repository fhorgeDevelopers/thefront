/*! Ahoy.js v0.4.0 | MIT License */
!function(e, t) {
    "object" == typeof exports && "undefined" != typeof module ? module.exports = t() : "function" == typeof define && define.amd ? define(t) : (e = e || self).ahoy = t()
}(this, function() {
    "use strict";
    var i = {
        set: function(e, t, n, i) {
            var r, o = "", a = "";
            n && ((r = new Date).setTime(r.getTime() + 60 * n * 1e3),
            o = "; expires=" + r.toGMTString()),
            i && (a = "; domain=" + i),
            document.cookie = e + "=" + escape(t) + o + a + "; path=/; samesite=lax"
        },
        get: function(e) {
            for (var t, n = e + "=", i = document.cookie.split(";"), r = 0; r < i.length; r++) {
                for (t = i[r]; " " === t.charAt(0); )
                    t = t.substring(1, t.length);
                if (0 === t.indexOf(n))
                    return unescape(t.substring(n.length, t.length))
            }
            return null
        }
    }
      , o = {
        urlPrefix: "",
        visitsUrl: "/ahoy/visits",
        eventsUrl: "/ahoy/events",
        page: null,
        platform: "Web",
        useBeacon: !0,
        startOnReady: !0,
        trackVisits: !0,
        cookies: !0,
        cookieDomain: null,
        headers: {},
        visitParams: {},
        withCredentials: !1,
        visitDuration: 240,
        visitorDuration: 1051200
    }
      , r = window.ahoy || window.Ahoy || {};
    r.configure = function(e) {
        for (var t in e)
            e.hasOwnProperty(t) && (o[t] = e[t])
    }
    ,
    r.configure(r);
    var n, a, s, c = window.jQuery || window.Zepto || window.$, u = !1, t = [], d = "undefined" != typeof JSON && void 0 !== JSON.stringify, f = [];
    function l() {
        return o.urlPrefix + o.eventsUrl
    }
    function h() {
        return (o.useBeacon || o.trackNow) && (e = o.headers,
        0 === Object.keys(e).length) && d && void 0 !== window.navigator.sendBeacon && !o.withCredentials;
        var e
    }
    function v(e, t, n) {
        i.set(e, t, n, o.cookieDomain || o.domain)
    }
    function g(e) {
        return i.get(e)
    }
    function m(e) {
        i.set(e, "", -1)
    }
    function y(e) {
        g("ahoy_debug") && window.console.log(e)
    }
    function p() {
        for (var e; e = t.shift(); )
            e();
        u = !0
    }
    function w(e, n, i) {
        document.addEventListener(e, function(e) {
            var t = function e(t, n) {
                var i = t.matches || t.matchesSelector || t.mozMatchesSelector || t.msMatchesSelector || t.oMatchesSelector || t.webkitMatchesSelector;
                return i ? i.apply(t, [n]) ? t : t.parentElement ? e(t.parentElement, n) : null : (y("Unable to match"),
                null)
            }(e.target, n);
            t && i.call(t, e)
        })
    }
    function k() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(e) {
            var t = 16 * Math.random() | 0;
            return ("x" == e ? t : 3 & t | 8).toString(16)
        })
    }
    function x() {
        o.cookies && d && v("ahoy_events", JSON.stringify(f), 1)
    }
    function _() {
        var e = document.querySelector("meta[name=csrf-token]");
        return e && e.content
    }
    function S(e) {
        var t = _();
        t && e.setRequestHeader("X-CSRF-Token", t)
    }
    function b(e, t, n) {
        if (d)
            if (c && c.ajax)
                c.ajax({
                    type: "POST",
                    url: e,
                    data: JSON.stringify(t),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    beforeSend: S,
                    success: n,
                    headers: o.headers,
                    xhrFields: {
                        withCredentials: o.withCredentials
                    }
                });
            else {
                var i, r = new XMLHttpRequest;
                for (i in r.open("POST", e, !0),
                r.withCredentials = o.withCredentials,
                r.setRequestHeader("Content-Type", "application/json"),
                o.headers)
                    o.headers.hasOwnProperty(i) && r.setRequestHeader(i, o.headers[i]);
                r.onload = function() {
                    200 === r.status && n()
                }
                ,
                S(r),
                r.send(JSON.stringify(t))
            }
    }
    function O(e) {
        var t = {
            events: [e]
        };
        return o.cookies && (t.visit_token = e.visit_token,
        t.visitor_token = e.visitor_token),
        delete e.visit_token,
        delete e.visitor_token,
        t
    }
    function T(t) {
        r.ready(function() {
            b(l(), O(t), function() {
                for (var e = 0; e < f.length; e++)
                    if (f[e].id == t.id) {
                        f.splice(e, 1);
                        break
                    }
                x()
            })
        })
    }
    function C(i) {
        r.ready(function() {
            var e = O(i)
              , t = (n = document.querySelector("meta[name=csrf-param]")) && n.content
              , n = _();
            t && n && (e[t] = n),
            e.events_json = JSON.stringify(e.events),
            delete e.events,
            window.navigator.sendBeacon(l(), function(e) {
                var t, n = new FormData;
                for (t in e)
                    e.hasOwnProperty(t) && n.append(t, e[t]);
                return n
            }(e))
        })
    }
    function P() {
        return o.page || window.location.pathname
    }
    function e(e) {
        return e && 0 < e.length ? e : null
    }
    function V() {
        return function(e) {
            for (var t in e)
                e.hasOwnProperty(t) && null === e[t] && delete e[t];
            return e
        }({
            tag: this.tagName.toLowerCase(),
            id: e(this.id),
            class: e(this.className),
            page: P(),
            section: function(e) {
                for (; e && e !== document; e = e.parentNode)
                    if (e.hasAttribute("data-section"))
                        return e.getAttribute("data-section");
                return null
            }(this)
        })
    }
    function M() {
        if (u = !1,
        n = r.getVisitId(),
        a = r.getVisitorId(),
        s = g("ahoy_track"),
        !1 === o.cookies || !1 === o.trackVisits)
            y("Visit tracking disabled"),
            p();
        else if (n && a && !s)
            y("Active visit"),
            p();
        else if (n || v("ahoy_visit", n = k(), o.visitDuration),
        g("ahoy_visit")) {
            y("Visit started"),
            a || v("ahoy_visitor", a = k(), o.visitorDuration);
            var e, t = {
                visit_token: n,
                visitor_token: a,
                platform: o.platform,
                landing_page: window.location.href,
                screen_width: window.screen.width,
                screen_height: window.screen.height,
                js: !0
            };
            for (e in 0 < document.referrer.length && (t.referrer = document.referrer),
            o.visitParams)
                o.visitParams.hasOwnProperty(e) && (t[e] = o.visitParams[e]);
            y(t),
            b(o.urlPrefix + o.visitsUrl, t, function() {
                m("ahoy_track"),
                p()
            })
        } else
            y("Cookies disabled"),
            p()
    }
    r.ready = function(e) {
        u ? e() : t.push(e)
    }
    ,
    r.getVisitId = r.getVisitToken = function() {
        return g("ahoy_visit")
    }
    ,
    r.getVisitorId = r.getVisitorToken = function() {
        return g("ahoy_visitor")
    }
    ,
    r.reset = function() {
        return m("ahoy_visit"),
        m("ahoy_visitor"),
        m("ahoy_events"),
        m("ahoy_track"),
        !0
    }
    ,
    r.debug = function(e) {
        return !1 === e ? m("ahoy_debug") : v("ahoy_debug", "t", 525600),
        !0
    }
    ,
    r.track = function(e, t) {
        var n = {
            name: e,
            properties: t || {},
            time: (new Date).getTime() / 1e3,
            id: k(),
            js: !0
        };
        return r.ready(function() {
            o.cookies && !r.getVisitId() && M(),
            r.ready(function() {
                y(n),
                n.visit_token = r.getVisitId(),
                n.visitor_token = r.getVisitorId(),
                h() ? C(n) : (f.push(n),
                x(),
                setTimeout(function() {
                    T(n)
                }, 1e3))
            })
        }),
        !0
    }
    ,
    r.trackView = function(e) {
        var t = {
            url: window.location.href,
            title: document.title,
            page: P()
        };
        if (e)
            for (var n in e)
                e.hasOwnProperty(n) && (t[n] = e[n]);
        r.track("$view", t)
    }
    ,
    r.trackClicks = function(e) {
        if (void 0 === e)
            throw new Error("Missing selector");
        w("click", e, function(e) {
            e = V.call(this, e);
            e.text = "input" == e.tag ? this.value : (this.textContent || this.innerText || this.innerHTML).replace(/[\s\r\n]+/g, " ").trim(),
            e.href = this.href,
            r.track("$click", e)
        })
    }
    ,
    r.trackSubmits = function(e) {
        if (void 0 === e)
            throw new Error("Missing selector");
        w("submit", e, function(e) {
            e = V.call(this, e);
            r.track("$submit", e)
        })
    }
    ,
    r.trackChanges = function(e) {
        if (y("trackChanges is deprecated and will be removed in 0.5.0"),
        void 0 === e)
            throw new Error("Missing selector");
        w("change", e, function(e) {
            e = V.call(this, e);
            r.track("$change", e)
        })
    }
    ;
    try {
        f = JSON.parse(g("ahoy_events") || "[]")
    } catch (e) {}
    for (var j, N = 0; N < f.length; N++)
        T(f[N]);
    return r.start = function() {
        M(),
        r.start = function() {}
    }
    ,
    j = function() {
        o.startOnReady && r.start()
    }
    ,
    "interactive" === document.readyState || "complete" === document.readyState ? setTimeout(j, 0) : document.addEventListener("DOMContentLoaded", j),
    r
});
